# TODO: consider hardware/qemu:
#   provides:
#     arch: x86_64
#     disk_devices:
#     - device: /dev/sda
#       partition_format: '/dev/sda%'
#     nics:
#     - name: eth0
# other properties can:
# require:
#   arch: x86_64

# TODO: allow loading properties from external files

properties:
- id: images/installer
  patches:
  - op: add
    path: /kernel
    value:
      path: bindeps/x86_64/bzImage
  - op: add
    path: /initrds
    value:
    - path: bindeps/x86_64/installer.cpio
  - op: add
    path: /vars/installer
    value:
      disks: []
      files: []
  - op: add
    path: /boot_args
    value:
    - "netboot_installer={{ .vars.installer | toRawJson | b64enc }}"
- id: disks/qemu_test
  patches:
  - op: add
    path: /files
    value:
    - id: qemu_test
      url: UBUNTU_URL
      sha256: CHECKSUM
  - op: add
    path: /vars/installer/disks
    value:
    - url: '{{ file "qemu_test" }}'
      dest_device: /dev/sda
      mounts:
      - partition: /dev/sda1
        path: /root
- id: templates/cloud_init_metadata
  patches:
  - op: add
    path: /files
    value:
    - id: cloud_init_metadata
      path: templates/cloud-init/meta-data
      template: true
      vars:
        cloud_init:
          hostname: ""
  - op: add
    path: /vars/installer/files
    value:
    - url: '{{ file "cloud_init_metadata" }}'
      dest: /root/var/lib/cloud/seed/nocloud/meta-data

hosts:
- mac: "52:54:00:12:34:56"
  properties:
  - id: images/installer
  - id: disks/qemu_test
  - id: templates/cloud_init_metadata
  vars:
    cloud_init:
      hostname: boot-test
      users:
      - name: boot-test
        # TODO: pull from secrets
        ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDOiRM5W54zjT2D+musmvgwfcmxBn3mayIA8JMvSYGDLy5DttHp3w27jkR7H85yCSqb96pCfjzhe4ECgNbtDfP0L88sQPsDuKA6eBThj0FHsHXdxQRyXUzZNEPkOAEfpgzTmISaBAXEtzeh0Nh4ttP7R0JRn+FQSVXfvYvlp+petfzbDxZtfxQTNQ82VrwNqndOzw1A4LL8Gr0wgKXmArFl/DVlEsMWk0OQanambuQhp66YSpIRGaiFIj8JTufG8IDL7lMYnmuqk/Ut6OfI/a/zo17RK4rNdVUhAckKfdfZM+SH/mDpmPCHgnm53rVZMxRX+PTYeDiJJemPMtYv9lACjQl4KRcweqLCrePgYysfzQw47qysA/HbzQtm4M69yvrwk+WxW1a/YFNTefD3hicyyLW5QnzP368iSambSV+Up7RTmvtx5gVmodxK5sRN8PAhk6tbQwOow1Y0ypgdWVaEpszM26me87T3jNfedA9GsU09YyqL5ZCvhKSN6xgtikYAHzWKo30Eqv7Xgw3/tEELwSL1owzK3b1ztvTpPefgthyTKtwVggmBbC2JTxxQCebPhGO5On7S2Yesv3Xwz+vvmxJmIOsQ/V1nrcq1XwWvtrSloeOIyhsATxRnnVqQVeQIp7C0DQuc/581uZisjSMByETzD6DtAsNbCgXoNtI4cw== boot-test
